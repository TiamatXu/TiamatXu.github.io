name: Deploy Github Pages

on:
  push:
    branches:
      - master
      - main
    paths:
      - '.vitepress/**'
      - 'src/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/**'
  workflow_dispatch:
  schedule:
    # 04:00 (UTC+8) | 20:00 (UTC)
    - cron: '0 20 * * *'

permissions:
  contents: read
  pages: write
  id-token: write
  deployments: write

environment:
  name: github-pages
  url: ${{ steps.deployment.outputs.page_url }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Create deployment record
        id: create_deploy
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const dep = await github.rest.repos.createDeployment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: process.env.GITHUB_SHA || context.sha,
                required_contexts: [],
                environment: "github-pages",
                transient_environment: false,
                description: `Deploy via Actions (Pages) - ${new Date().toISOString()}`
              });
              core.setOutput("deployment_id", String(dep.data.id));
              core.info(`Created deployment record with ID: ${dep.data.id}`);
            } catch (error) {
              core.setFailed(`Failed to create deployment record: ${error.message}`);
              throw error;
            }

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          registry-url: https://registry.npmmirror.com/

      - name: Install dependencies
        run: |
          pnpm --version
          pnpm install --frozen-lockfile
        continue-on-error: false

      - name: Set build environment variables
        run: |
          echo "VITE_APP_BUILD_TIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV
          echo "VITE_APP_GIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "VITE_APP_GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_ENV

      - name: Build VitePress Site
        run: pnpm run build
        env:
          NODE_ENV: production
        continue-on-error: false

      - name: Validate build output
        run: |
          if [ ! -d ".vitepress/dist" ]; then
            echo "Error: Build directory .vitepress/dist does not exist!"
            exit 1
          fi
          if [ -z "$(ls -A .vitepress/dist)" ]; then
            echo "Error: Build directory is empty!"
            exit 1
          fi
          echo "✅ Build output validation passed"

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .vitepress/dist
          retention-days: 30

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        continue-on-error: false

      - name: Update deployment status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentId = parseInt(core.getInput('deployment_id') || `${{ steps.create_deploy.outputs.deployment_id }}`);
            // 确定部署状态：根据上一步的结果设置 success/failure
            const deploymentState = ${{ steps.deployment.outcome == 'success' }} ? 'success' : 'failure';

            // 构造 Pages URL（兼容不同仓库类型：用户/组织/项目）
            const repoName = context.repo.repo;
            const owner = context.repo.owner;
            let pageUrl = '';
            if (${{ steps.deployment.outputs.page_url }}) {
              pageUrl = '${{ steps.deployment.outputs.page_url }}';
            } else {
              // 通用 Pages URL 构造规则
              pageUrl = repoName === `${owner}.github.io`
                ? `https://${owner}.github.io`
                : `https://${owner}.github.io/${repoName}`;
            }

            try {
              await github.rest.repos.createDeploymentStatus({
                owner: owner,
                repo: repoName,
                deployment_id: deploymentId,
                state: deploymentState,
                environment_url: pageUrl,
                log_url: `https://github.com/${owner}/${repoName}/actions/runs/${context.runId}`,
                description: `Deployment ${deploymentState}: ${new Date().toISOString()}`
              });
              core.info(`Updated deployment ${deploymentId} status to ${deploymentState}`);
            } catch (error) {
              core.warning(`Failed to update deployment status: ${error.message}`);
            }
